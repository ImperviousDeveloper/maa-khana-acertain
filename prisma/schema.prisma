// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum Role {
    USER
    ADMIN
}

enum AddressType {
    HOME
    WORK
    BILLING
    SHIPPING
}

enum OrderStatus {
    PENDING
    CONFIRMED
    SHIPPED
    OUT_FOR_DELIVERY
    DELIVERED
    CANCELLED
    RETURNED
    REFUNDED
}

enum PaymentStatus {
    PENDING
    SUCCESS
    FAILED
    REFUNDED
}

// NextAuth Models
model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?
    user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

// User & E-commerce Models
model User {
    id            String    @id @default(cuid())
    name          String?
    email         String    @unique
    password      String?
    emailVerified DateTime?
    image         String?
    role          Role      @default(USER)
    createdAt     DateTime  @default(now())

    otp               String?
    otpExpires        DateTime?
    resetToken        String?   @unique
    resetTokenExpires DateTime?

    accounts       Account[]
    sessions       Session[]
    addresses      Address[]
    orders         Order[]
    cart           Cart?
    reviews        Review[]
    wishlist       Wishlist[]
    notifications  Notification[]
    recentlyViewed RecentlyViewedItem[]
}

model Address {
    id        String      @id @default(cuid())
    line1     String
    line2     String?
    city      String
    state     String
    country   String
    zipCode   String
    phone     String?
    type      AddressType
    isDefault Boolean     @default(false)

    userId String
    user   User   @relation(fields: [userId], references: [id])

    createdAt DateTime @default(now())

    @@index([userId])
}

model Category {
    id       Int        @id @default(autoincrement())
    name     String
    slug     String     @unique
    parentId Int?
    parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
    children Category[] @relation("CategoryTree")

    products Product[]

    @@index([parentId])
    @@index([slug])
}

model Product {
    id           Int      @id @default(autoincrement())
    name         String
    slug         String   @unique
    description  String
    brand        String?
    price        Decimal  @db.Decimal(10, 2)
    specialPrice Decimal? @db.Decimal(10, 2)
    discount     Decimal? @db.Decimal(10, 2)
    rating       Float    @default(0)
    reviewsCount Int      @default(0)

    imageUrl   String
    isActive   Boolean @default(true)
    isFeatured Boolean @default(false)

    stock   Int     @default(0)
    inStock Boolean @default(true)

    categoryId Int
    category   Category @relation(fields: [categoryId], references: [id])

    variants         ProductVariant[]
    images           ProductImage[]
    reviews          Review[]
    cartItems        CartItem[]
    orderItems       OrderItem[]
    wishlistedBy     Wishlist[]
    recentlyViewedBy RecentlyViewedItem[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([categoryId])
    @@index([slug])
    @@index([isActive])
    @@index([isFeatured])
}

model ProductVariant {
    id        Int     @id @default(autoincrement())
    productId Int
    product   Product @relation(fields: [productId], references: [id])

    name   String
    sku    String?
    size   String?
    flavor String?
    weight String?

    additionalPrice Decimal? @db.Decimal(10, 2)

    createdAt DateTime   @default(now())
    CartItem  CartItem[]

    @@index([productId])
}

model ProductImage {
    id        String  @id @default(cuid())
    url       String
    productId Int
    product   Product @relation(fields: [productId], references: [id])

    @@index([productId])
}

model Cart {
    id     String @id @default(cuid())
    userId String @unique
    user   User   @relation(fields: [userId], references: [id])

    totalPrice     Decimal @default(0) @db.Decimal(10, 2)
    totalDiscount  Decimal @default(0) @db.Decimal(10, 2)
    taxAmount      Decimal @default(0) @db.Decimal(10, 2)
    shippingCost   Decimal @default(0) @db.Decimal(10, 2)
    couponDiscount Decimal @default(0) @db.Decimal(10, 2)

    appliedCoupon String?

    items CartItem[]
}

model CartItem {
    id     String @id @default(cuid())
    cartId String
    cart   Cart   @relation(fields: [cartId], references: [id])

    productId Int
    product   Product @relation(fields: [productId], references: [id])

    variantId Int?
    variant   ProductVariant? @relation(fields: [variantId], references: [id])

    quantity Int
    price    Decimal @db.Decimal(10, 2)

    @@index([cartId])
    @@index([productId])
}

model Coupon {
    id             Int       @id @default(autoincrement())
    code           String    @unique
    discountType   String
    discountAmount Decimal   @db.Decimal(10, 2)
    minOrderAmount Decimal   @default(0) @db.Decimal(10, 2)
    usageLimit     Int       @default(100)
    currentUsage   Int       @default(0)
    active         Boolean
    expiryDate     DateTime?

    @@index([code])
}

model Order {
    id     String @id @default(cuid())
    userId String
    user   User   @relation(fields: [userId], references: [id])

    status    OrderStatus @default(PENDING)
    total     Decimal     @db.Decimal(10, 2)
    createdAt DateTime    @default(now())

    items    OrderItem[]
    payment  Payment?
    shipping Shipping?

    @@index([userId])
    @@index([status])
    @@index([createdAt])
}

model OrderItem {
    id      Int    @id @default(autoincrement())
    orderId String
    order   Order  @relation(fields: [orderId], references: [id])

    productId Int
    product   Product @relation(fields: [productId], references: [id])

    quantity Int
    price    Decimal  @db.Decimal(10, 2)
    discount Decimal? @db.Decimal(10, 2)

    @@index([orderId])
    @@index([productId])
}

model Payment {
    id      Int    @id @default(autoincrement())
    orderId String @unique
    order   Order  @relation(fields: [orderId], references: [id])

    method        String
    transactionId String?
    status        PaymentStatus @default(PENDING)
    amount        Decimal       @db.Decimal(10, 2)
    currency      String        @default("INR")

    @@index([orderId])
}

model Shipping {
    id      Int    @id @default(autoincrement())
    orderId String @unique
    order   Order  @relation(fields: [orderId], references: [id])

    method            String
    cost              Decimal   @db.Decimal(10, 2)
    carrier           String?
    trackingNumber    String?
    estimatedDelivery DateTime?

    @@index([orderId])
}

model Review {
    id        Int    @id @default(autoincrement())
    productId Int
    userId    String

    product Product @relation(fields: [productId], references: [id])
    user    User    @relation(fields: [userId], references: [id])

    rating    Int
    comment   String?
    createdAt DateTime @default(now())

    @@index([productId])
    @@index([userId])
}

model Wishlist {
    id        Int      @id @default(autoincrement())
    userId    String
    user      User     @relation(fields: [userId], references: [id])
    productId Int
    product   Product  @relation(fields: [productId], references: [id])
    createdAt DateTime @default(now())

    @@index([userId])
    @@index([productId])
}

model Notification {
    id        Int      @id @default(autoincrement())
    userId    String
    user      User     @relation(fields: [userId], references: [id])
    title     String
    message   String
    type      String
    isRead    Boolean  @default(false)
    createdAt DateTime @default(now())

    @@index([userId])
}

model RecentlyViewedItem {
    id        Int      @id @default(autoincrement())
    userId    String
    user      User     @relation(fields: [userId], references: [id])
    productId Int
    product   Product  @relation(fields: [productId], references: [id])
    viewedAt  DateTime @default(now())

    @@index([userId])
    @@index([productId])
    @@index([viewedAt])
}

model ContactMessage {
    id        Int      @id @default(autoincrement())
    name      String
    email     String
    message   String
    createdAt DateTime @default(now())
}
